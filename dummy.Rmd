---
title: "dummy"
author: "AES Technical"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r libraries}
# import libraries
library(tidyverse)
library(broom)
library(kableExtra)
```

``` {r initial_mass}
# define parameters
bw_0 <- 0.07
```

## Deliverables:

* Develop growth model
* Develop production plan
* Perform system mass balance equations
* Develop prototype system

***

## Growth Modeling

Growth model based on data supplied from SyAqua Americas 95^th^ st.facility.

**_Litopenaeus vannamei_** growth characteristics:

``` {r growth_data}

# import data
shrimp_growout <- read.csv("data/shrimp_growout.csv")

# find weight gain for weight midpoint
shrimp.growth <- shrimp_growout %>%
  mutate(wt.mid = (wt_2 + wt_1) / 2,
         g.gain.day = (wt_2 - wt_1) / (t_2 - t_1),
         geometric.mid = sqrt(wt_1 * wt_2))
```

```{r growth_model}

# try base code log-log relationship - looks good!
shrimp.fit.twinlog <- lm(log(g.gain.day) ~ log(wt.mid), data = shrimp.growth)

# calculate coefficients for growth curve bw_1 = [bw_0^c_1 + c_2 * days]^c_4
c_1 <- 1 - shrimp.fit.twinlog$coef[2]
c_2 <- c_1 * exp(shrimp.fit.twinlog$coef[1])
c_4 <- 1 / c_1

# try base code log-log relationship for geometric weight
shrimp.geometric.twinlog <- lm(log(g.gain.day) ~ log(geometric.mid), data = shrimp.growth)

# calculate coefficients for growth curve bw_1 = [bw_0^c_1 + c_2 * days]^c_4
geometric_c_1 <- 1 - shrimp.geometric.twinlog$coef[2]
geometric_c_2 <- c_1 * exp(shrimp.geometric.twinlog$coef[1])
geometric_c_4 <- 1 / geometric_c_1
```

```{r growth_model_plot, fig.cap = "Daily growth rate by mass - datapoints from SyAqua $95^{th} st.$ (blue - arithmetric model, black - geometric model).", fig.align = "center", fig.dim = c(8,5)}

# set some colours
cols <- c("quarantine" = "#bdc9e1", "nursery" = "#74a9cf", "juvenile" = "#2b8cbe", "growout" = "#045a8d")

# plot relationship between weight and grams gained per day 
p_shrimp_gain <- shrimp.growth %>%
  ggplot(aes(wt.mid, g.gain.day, color = phase)) +
  geom_point() +
  scale_color_manual(name = "Phase",
  labels = c("quarantine" = "Quarantine", "nursery" = "Nursery", "juvenile" = "Juvenile", "growout" = "Growout"),
  values = c(cols)) +
  stat_function(fun = function(x) exp(shrimp.fit.twinlog$coef[1]) * x^shrimp.fit.twinlog$coef[2], color = 'dodgerblue') +
  stat_function(fun = function(x) exp(shrimp.geometric.twinlog$coef[1]) * x^shrimp.geometric.twinlog$coef[2], color = 'black') +
  xlab("Mass (g)") +
  ylab("Daily mass gain (g/shrimp/day)") +
  theme_minimal()

p_shrimp_gain
```

***

From the growth model, an estimate of white-leg shrimp body mass - as a function of time from introduction - can be calculated.

``` {r bodyweight}

# estimate body-weight over time
bodyweight <- tibble(day = seq(1,180,1)) %>%
  mutate(bw = (bw_0^c_1 + c_2 * day)^c_4)

# import fellsmere growth data
fellsmere.growth <- read.csv("data/fellsmere_growth.csv")

# create model to incorporate fellsmere growth data
bodyweight.model <- bodyweight %>%
  mutate(data.source = "model") %>%
  bind_rows(fellsmere.growth)
```

``` {r shrimp_mass_plot, fig.cap = "Estimated shrimp mass at time from introduction (blue - arithmetic model, black - geometric model).", fig.align = "center", fig.dim = c(8, 4)}

# shrimp growth model compared to fellsmere
shrimp.model.plot <- 
  bodyweight.model %>%
  ggplot(aes(day, bw, color = data.source)) +
  geom_line() +
  stat_function(fun = function(x) (bw_0^geometric_c_1 + geometric_c_2 * x)^geometric_c_4, color = 'black') +
  labs(x = "Days", y = "Mass (g)") +
  scale_color_discrete(name = "Data source", labels = c("Fellsmere", "Model")) +
  theme_minimal()

shrimp.model.plot
```

``` {r target_mass}

# define parameters
quarantine.max <- 1.2
nursery.max <- 3
juvenile.max <- 10
growout.max <- 32
nursery.harvest <- 5

shrimp.1_2.g <- ceiling(which(abs(bodyweight$bw - quarantine.max) == min(abs(bodyweight$bw - quarantine.max))))

shrimp.3.g <- ceiling(which(abs(bodyweight$bw - nursery.max) == min(abs(bodyweight$bw - nursery.max))))

shrimp.5.g <- ceiling(which(abs(bodyweight$bw - nursery.harvest) == min(abs(bodyweight$bw - nursery.harvest))))

shrimp.10.g <- ceiling(which(abs(bodyweight$bw - juvenile.max) == min(abs(bodyweight$bw - juvenile.max))))

shrimp.32.g <- ceiling(which(abs(bodyweight$bw - growout.max) == min(abs(bodyweight$bw - growout.max))))
```

### Projected day to attain key bodyweights:

* Estimated growth day for `r quarantine.max`g shrimp: Day `r shrimp.1_2.g`
* Estimated growth day for `r nursery.max`g shrimp: Day `r shrimp.3.g`
* Estimated growth day for `r nursery.harvest`g shrimp: Day `r shrimp.5.g`
* Estimated growth day for `r juvenile.max`g shrimp: Day `r shrimp.10.g`
* Estimated growth day for `r growout.max`g shrimp: Day `r shrimp.32.g`

***

## Production Plan

``` {r harvest_targets}

harvest.day.1 <- 150
harvest.day.2 <- 180

harvest.95.1 <- 2200
harvest.95.2 <- 600

harvest.primo.1 <- 1200
harvest.primo.2 <- 1000
harvest.primo.3 <- 600

harvest.101.1 <- 1200
harvest.101.2 <- 600
harvest.101.3 <- 600
```

### Review production plan(s) to achieve:  

* 95^th^ st. 2022. Day `r harvest.day.1` harvest `r harvest.95.1` individual `r growout.max`g shrimp per raceway.
* 95^th^ st. 2022. Day `r harvest.day.2` harvest `r harvest.95.2` individual `r growout.max`g shrimp per raceway.  

* 95^th^ st. 2023. Day `r shrimp.32.g` harvest `r harvest.primo.1` individual `r growout.max`g shrimp per raceway.
* 95^th^ st. 2023. Day `r shrimp.32.g + 15` harvest `r harvest.primo.2` individual `r growout.max`g shrimp per raceway.
* 95^th^ st. 2023. Day `r shrimp.32.g + 30` harvest `r harvest.primo.3` individual `r growout.max`g shrimp per raceway.  
  
* 101^st^ st. Day `r shrimp.32.g` harvest `r harvest.101.1` individual `r growout.max`g shrimp per raceway.
* 101^st^ st. Day `r shrimp.32.g + 15` harvest `r harvest.101.2` individual `r growout.max`g shrimp per raceway.
* 101^st^ st. Day `r shrimp.32.g + 30` harvest `r harvest.101.3` individual `r growout.max`g shrimp per raceway.  
\newpage

***

### System Occupation 95^th^ st. 2022:

``` {r system_occupation}
batch_frequency <- 30 # days between batches
batch_system_periods <- 1 # overall number of system periods
production_cycle <- 190 # period whose factor includes frequency, system period and exceeds minimum growout period
quarantine.period <- 29
nursery.period <- 30
juvenile.period <- 30
growout.period <- 90
depuration.period <- ceiling((harvest.95.1 + harvest.95.2) * 2 / 1600)
```

* Quarantine `r quarantine.period + 1` days.
* Nursery `r nursery.period` days.
* Juvenile `r juvenile.period` days.
* Grow-out up to `r growout.period` days.
* Depuration `r depuration.period` days.

``` {r prod_plan_95}

# set production period to two growth periods to observe system loading
prod_plan <- data.frame(facility_day = seq(0, 2 * production_cycle - 1)) %>%
  mutate(batch_1 = case_when(facility_day < production_cycle ~ facility_day))

for (lag_size in c(0:12)) {
  
  new_col_name <- paste0("lag.batch.", lag_size)
  
  prod_plan <- prod_plan %>%
    mutate(!!sym(new_col_name) := lag(batch_1, n = lag_size * batch_frequency, default = NA))
}

# remove column called batch_1
prod.plan <- prod_plan %>% select(-batch_1) %>%
  pivot_longer(c(lag.batch.0:lag.batch.12), names_to = "batch", values_to = "batch_day", values_drop_na = TRUE) %>%
  mutate(system = case_when(batch_day %in% c(0:quarantine.period) ~ "quarantine",
                            batch_day %in% c(quarantine.period + 1: nursery.period) ~ "nursery",
                            batch_day %in% c(quarantine.period + nursery.period + 1 : juvenile.period) ~ "juvenile",
                            batch_day %in% c(quarantine.period + nursery.period + juvenile.period + 1 : growout.period) ~ "growout",
                            batch_day %in% c(quarantine.period + nursery.period + juvenile.period + growout.period + 1 : depuration.period)  ~ "depurate")) %>%
  drop_na() %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.2", "lag.batch.5", "lag.batch.7", "lag.batch.10"))
```

``` {r system_95_plot, fig.cap = "$95^{th} st.$ (2022). production schematic.", fig.align = "center", fig.dim = c(8, 3), fig.pos = "h"}

# custom color
system_cols <- c(quarantine = "#d0d1e6", nursery = "#a6bddb", juvenile = "#74a9cf", growout = "#2b8cbe", depurate = "#045a8d")

systems_plot <- prod.plan %>%
  filter(batch_day <= production_cycle,
         batch %in% c("lag.batch.0", "lag.batch.2", "lag.batch.5", "lag.batch.7", "lag.batch.10")) %>%
  ggplot(aes(facility_day, batch, color = system)) +
  geom_line(size = 3) +
  scale_y_discrete(limits = c("lag.batch.0", "lag.batch.2", "lag.batch.5", "lag.batch.7", "lag.batch.10"),
                   labels = c("Batch 1", "Batch 2", "Batch 3", "Batch 4", "Batch 5")) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "juvenile", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Juvenile", "Growout", "Depurate")) +
  labs(x = "Day", y = "") + 
  theme_minimal()

systems_plot
```

***

### System Occupation 95^th^st 2023:

```{r system_occupation_primo}

# production plan primo 95
# define parameters
harvest.day.1.primo <- 150
harvest.day.2.primo <- 180
batch_frequency.primo <- 60 # days between batches
batch_system_periods.primo <- 1 # overall number of system periods
production_cycle.primo <- 210
quarantine.period.primo <- 29
nursery.period.primo <- 60
growout.period.primo <- 110
depuration.period.primo <- ceiling((harvest.95.1 + harvest.95.2) * 2 / 1600)
```

* Quarantine `r quarantine.period.primo + 1` days.
* Nursery `r nursery.period.primo` days.
* Grow-out up to `r growout.period.primo` days.
* Depuration `r depuration.period.primo` days.

``` {r prod_plan_primo}

# set primo production period to two growth periods to observe system loading
prod_plan_primo <- data.frame(facility_day = seq(0, 2 * production_cycle.primo - 1)) %>%
  mutate(batch_1 = case_when(facility_day < production_cycle.primo ~ facility_day))

for (lag_size in c(0:12)) {
  
  new_col_name <- paste0("lag.batch.", lag_size)
  
  prod_plan_primo <- prod_plan_primo %>%
    mutate(!!sym(new_col_name) := lag(batch_1, n = lag_size * batch_frequency.primo, default = NA))
}

# remove column called batch_1 from prod_plan_primo
prod.plan.primo <- prod_plan_primo %>% select(-batch_1) %>%
  pivot_longer(c(lag.batch.0:lag.batch.12), names_to = "batch", values_to = "batch_day", values_drop_na = TRUE) %>%
  mutate(system = case_when(batch_day %in% c(0:quarantine.period.primo) ~ "quarantine",
                            batch_day %in% c(quarantine.period.primo + 1 : nursery.period.primo ) ~ "nursery",
                            batch_day %in% c(quarantine.period.primo + nursery.period.primo + 1 : growout.period.primo) ~ "growout",
                            batch_day %in% c(quarantine.period.primo + nursery.period.primo  + growout.period.primo + 1 : depuration.period.primo)  ~ "depurate")) %>%
  drop_na()
```

``` {r systems_plot_primo, fig.cap = "$95^{th} st.$ (2023). production schematic.", fig.align = "center", fig.dim = c(8,3), fig.pos = "h"}

# custom color
system_cols.primo <- c(quarantine = "#d0d1e6", nursery = "#a6bddb", growout = "#2b8cbe", depurate = "#045a8d")

systems_plot.primo <- prod.plan.primo %>%
  filter(batch_day <= production_cycle.primo,
         batch %in% c('lag.batch.0', 'lag.batch.1', 'lag.batch.2', 'lag.batch.3', 'lag.batch.4', 'lag.batch.5', 'lag.batch.6')) %>%
  ggplot(aes(facility_day, batch, color = system)) +
  geom_line(size = 3) +
  scale_y_discrete(limits = c('lag.batch.0', 'lag.batch.1', 'lag.batch.2', 'lag.batch.3', 'lag.batch.4', 'lag.batch.5', 'lag.batch.6'),
                   labels = c("Batch 1", "Batch 2", "Batch 3", "Batch 4", "Batch 5", "Batch 6", "Batch 7")) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Day", y = "") + 
  theme_minimal()

systems_plot.primo
```

***

### System Occupation 101^st^st 2024:

``` {r system_occupation_101}

# production plan 101
# define parameters
harvest.day.101.1 <- 150
harvest.day.101.2 <- 180
batch_frequency.101 <- 60 # days between batches
batch_system_periods.101 <- 1 # overall number of system periods
production_cycle.101 <- 210
quarantine.period.101 <- 29
nursery.period.101 <- 60
growout.period.101 <- 110
depuration.period.101 <- ceiling((harvest.101.1 + harvest.101.2) * 6 / 1600)
```

* Quarantine `r quarantine.period.101 + 1` days.
* Nursery `r nursery.period.101` days.
* Grow-out up to `r growout.period.101` days.
* Depuration `r depuration.period.101` days.

``` {r prod_plan_101}

# set primo production period to two growth periods to observe system loading
prod_plan_101 <- data.frame(facility_day = seq(0, 2 * production_cycle.101 - 1)) %>%
  mutate(batch_1 = case_when(facility_day < production_cycle.101 ~ facility_day))

for (lag_size in c(0:12)) {
  
  new_col_name <- paste0("lag.batch.", lag_size)
  
  prod_plan_101 <- prod_plan_101 %>%
    mutate(!!sym(new_col_name) := lag(batch_1, n = lag_size * batch_frequency.101, default = NA))
}

# remove column called batch_1 from prod_plan_101
prod.plan.101 <- prod_plan_101 %>% select(-batch_1) %>%
  pivot_longer(c(lag.batch.0:lag.batch.12), names_to = "batch", values_to = "batch_day", values_drop_na = TRUE) %>%
  mutate(system = case_when(batch_day %in% c(0:quarantine.period.101) ~ "quarantine",
                            batch_day %in% c(quarantine.period.101 + 1 : nursery.period.101) ~ "nursery",
                            batch_day %in% c(quarantine.period.101 + nursery.period.101 + 1 : growout.period.101) ~ "growout",
                            batch_day %in% c(quarantine.period.101 + nursery.period.101  + growout.period.101 + 1 : depuration.period.101)  ~ "depurate")) %>%
  drop_na()
```

``` {r systems_101_plot, fig.cap = "$101^{st} st.$ (2024). production schematic.", fig.align = "center", fig.dim = c(8,3), fig.pos = "h"}

# custom color
system_cols.101 <- c(quarantine = "#d0d1e6", nursery = "#a6bddb", growout = "#2b8cbe", depurate = "#045a8d")

systems_plot.101 <- prod.plan.101 %>%
  filter(batch_day <= production_cycle.101,
         batch %in% c('lag.batch.0', 'lag.batch.1', 'lag.batch.2', 'lag.batch.3', 'lag.batch.4', 'lag.batch.5', 'lag.batch.6')) %>%
  ggplot(aes(facility_day, batch, color = system)) +
  geom_line(size = 3) +
  scale_y_discrete(limits = c('lag.batch.0', 'lag.batch.1', 'lag.batch.2', 'lag.batch.3', 'lag.batch.4', 'lag.batch.5', 'lag.batch.6'),
                   labels = c("Batch 1", "Batch 2", "Batch 3", "Batch 4", "Batch 5", "Batch 6", "Batch 7")) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Day", y = "") + 
  theme_minimal()

systems_plot.101
```

***

## System Loading

``` {r shrimp_survival}
quarantine.in <- 35000
nursery.in <- 19500
juvenile.in <- 15000
growout.in <- 11000
growout.out <- 8800
depurate.in <- 1600

quarantine.survival <- 0.8
nursery.survival <- 0.8
juvenile.survival <- 0.8
growout.survival <- 0.8

```

Parameters used:

* Quarantine survival `r format(quarantine.survival * 100, scientific = FALSE, digits = 3)` %
* Nursery survival `r format(nursery.survival * 100, scientific = FALSE, digits = 3)` %
* Juvenile survival `r format(juvenile.survival * 100, scientific = FALSE, digits = 3)` % (95^th^st 2022 only)
* Growout survival `r format(growout.survival * 100, scientific = FALSE, digits = 3)` %

``` {r feed_model}

nursery.feed <- 0.05
growout.feed <- 0.04
depurate.feed <- 0

quarantine.protein <- 0.5
nursery.protein <- 0.4
juvenile.protein <- 0.4
growout.protein <- 0.35
depurate.protein <- 0.35

# import data
feed <- read.csv("data/feed.csv")

# filter phases of interest
quarantine.feed <- feed %>%
  filter(phase == "quarantine")

juvenile.feed <- feed %>%
  filter(phase == "juvenile")

juvenile.nursery.feed <- feed %>%
  filter(phase == "juvenile" | phase == "nursery")

quarantine.feed.twinlog <- lm(log(feed_pc) ~ log(wt), data = quarantine.feed)

juvenile.feed.log <- lm(log(feed_pc) ~ wt, data = juvenile.feed)

juvenile.nursery.feed.log <- lm(log(feed_pc) ~ wt, data = juvenile.nursery.feed)
```

``` {r facility_95}

quarantine.system.division <- 1
nursery.system.division <- 3
juvenile.system.division <- 1
growout.system.division <- 2
depurate.system.division <- 1
depurate.tanks <- 4

initial.stock <- 35000
```

95^th^ st. 2022 system designations:

* Quarantine - initial population of `r format(initial.stock, scientific = FALSE)` individuals of body-weight `r bw_0` : `r quarantine.max`
* Nursery - divide `r format(nursery.in, scientific = FALSE)`, `r quarantine.max`g, shrimp between `r nursery.system.division` independently operating tank(s), raise to `r nursery.max`g.
* Juvenile - rear `r format(juvenile.in, scientific = FALSE)`, `r nursery.max`g, shrimp within `r juvenile.system.division` tank(s), raise to `r juvenile.max`g.
* Growout - rear `r format(growout.in, scientific = FALSE)`, `r juvenile.max`g, shrimp within `r growout.system.division` tank(s), raise to `r growout.max`g.
* Depuration - purge up to `r format(depurate.in, scientific = FALSE)`, `r growout.max`g shrimp - split between `r depurate.tanks` tank(s), operated by `r depurate.system.division` treatment system(s).

``` {r system_loading_95}

# build system loading onto production plan
system.loading <- prod.plan %>%
  mutate(total.number = case_when(system == "quarantine" ~ initial.stock * exp(1)^(log(quarantine.survival) / quarantine.period * batch_day),
                                  system == "nursery" ~ nursery.in * exp(1)^(log(nursery.survival) / nursery.period * (batch_day - (quarantine.period + 1))),
                                  system == "juvenile" ~ juvenile.in * exp(1)^(log(juvenile.survival) / juvenile.period * (batch_day - (quarantine.period + 1) - nursery.period)),
                                  system == "growout" ~ growout.in * exp(1)^(log(growout.survival) / growout.period * (batch_day - (quarantine.period + 1) - nursery.period - juvenile.period)),
                                  system == "depurate" ~ depurate.in),
         total.number = case_when(system == "growout" & batch_day >= harvest.day.1 ~ total.number - harvest.95.1 * 2, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= harvest.day.2 ~ total.number - harvest.95.2 * 2, TRUE ~ total.number),
         process.number = case_when(system == "quarantine" ~ total.number / quarantine.system.division,
                                 system == "nursery" ~ total.number / nursery.system.division,
                                 system == "juvenile" ~ total.number / juvenile.system.division,
                                 system == "growout" ~ total.number / growout.system.division,
                                 system == "depurate" ~ total.number / depurate.system.division),
         bw = case_when(system == "depurate" ~ 32, TRUE ~ (bw_0^c_1 + c_2 * batch_day)^c_4),
         feed.rate = case_when(system == "quarantine" ~ exp(quarantine.feed.twinlog$coef[1]) * bw ^ quarantine.feed.twinlog$coef[2],
                               system == "nursery" ~ nursery.feed,
                               system == "juvenile" ~ exp(juvenile.feed.log$coef[1] + bw * juvenile.feed.log$coef[2]),
                               system == "growout" ~ growout.feed,
                               system == "depurate" ~ depurate.feed),
         protein.proportion = case_when(system == "quarantine" ~ quarantine.protein,
                                        system == "nursery" ~ nursery.protein,
                                        system == "juvenile" ~ juvenile.protein,
                                        system == "growout" ~ growout.protein,
                                        system == "depurate" ~ depurate.protein),
         total.bw.kg = bw * total.number / 1000,
         total.feed.kg = total.bw.kg * feed.rate,
         total.protein = total.feed.kg * protein.proportion,
         process.bw.kg = bw * process.number / 1000,
         process.feed.kg = process.bw.kg * feed.rate,
         process.protein = process.feed.kg * protein.proportion)
```

``` {r system_individuals_95, fig.cap = "Total number of individuals per phase ($95^{th} st.$ 2022).", fig.align = "center", fig.dim = c(8,4)}

system.n.95 <- system.loading %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, total.number, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "juvenile", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Juvenile", "Growout", "Depurate")) +
  labs(x = "Day", y = "Number of Shrimp in Batch") + 
  theme_minimal()

system.n.95
```

``` {r process_individuals_95, fig.cap = "Total number of individuals per process ($95^{th} st.$ 2022).", fig.align = "center", fig.dim = c(8,4)}

tank.n.95 <- system.loading %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, process.number, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "Number of Shrimp in Process") + 
  theme_minimal()

tank.n.95
```

95^th^ st. 2023 system designations:

``` {r facility_primo}

# system loading for primo
quarantine.in.primo <- 65000
nursery.in.primo <- 44000
growout.in.primo <- 16500
growout.out.primo <- 13200
depurate.in.primo <- 1600
nursery.harvest.primo <- 4000

harvest.primo.1 <- 1200
harvest.primo.2 <- 1000
harvest.primo.3 <- 600

quarantine.primo.division <- 1
nursery.primo.division <- 2
growout.primo.division <- 3
depurate.primo.division <- 1
depurate.tanks.primo <- 4
```

* Quarantine - initial population of `r format(quarantine.in.primo, scientific = FALSE)` individuals of body-weight `r bw_0` : `r quarantine.max`
* Nursery - divide `r format(nursery.in.primo, scientific = FALSE)`, `r quarantine.max`g, shrimp between `r nursery.primo.division` independently operating tank(s), raise to `r juvenile.max`g.
* Growout - rear `r format(growout.in.primo, scientific = FALSE)`, `r juvenile.max`g, shrimp within `r growout.primo.division` tank(s), raise to `r growout.max`g.
* Depuration - purge up to `r format(depurate.in.primo, scientific = FALSE)`, `r growout.max`g shrimp - split between `r depurate.tanks.primo` tank(s), operated by `r depurate.primo.division` treatment system(s).

``` {r system_loading_primo}

# build system loading onto production plan
system.loading.primo <- prod.plan.primo %>%
  mutate(total.number = case_when(system == "quarantine" ~ quarantine.in.primo * exp(1)^(log(quarantine.survival) / quarantine.period.primo * batch_day),
                                  system == "nursery" ~ nursery.in.primo * exp(1)^(log(nursery.survival) / nursery.period.primo * (batch_day - (quarantine.period.primo + 1))),
                                  system == "growout" ~ growout.in.primo * exp(1)^(log(growout.survival) / growout.period.primo * (batch_day - (quarantine.period.primo + 1) - nursery.period.primo)),
                                  system == "depurate" ~ depurate.in.primo),
         total.number = case_when(system == "nursery" & batch_day >= shrimp.5.g ~ total.number - nursery.harvest.primo * nursery.primo.division, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g ~ total.number - harvest.primo.1 * growout.primo.division, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 15 ~ total.number - harvest.primo.2 * growout.primo.division, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 30 ~ total.number - harvest.primo.3 * growout.primo.division, TRUE ~ total.number),
         process.number = case_when(system == "quarantine" ~ total.number / quarantine.primo.division,
                                    system == "nursery" ~ total.number / nursery.primo.division,
                                    system == "growout" ~ total.number / growout.primo.division,
                                    system == "depurate" ~ total.number / depurate.primo.division),
         bw = case_when(system == "depurate" ~ 32, TRUE ~ (bw_0^c_1 + c_2 * batch_day)^c_4),
         feed.rate = case_when(system == "quarantine" ~ exp(quarantine.feed.twinlog$coef[1]) * bw ^ quarantine.feed.twinlog$coef[2],
                               system == "nursery" ~ exp(juvenile.nursery.feed.log$coef[1] + bw * juvenile.nursery.feed.log$coef[2]),
                               system == "growout" ~ growout.feed,
                               system == "depurate" ~ depurate.feed),
         protein.proportion = case_when(system == "quarantine" ~ quarantine.protein,
                                        system == "nursery" ~ nursery.protein,
                                        system == "growout" ~ growout.protein,
                                        system == "depurate" ~ depurate.protein),
         total.bw.kg = bw * total.number / 1000,
         total.feed.kg = total.bw.kg * feed.rate,
         total.protein = total.feed.kg * protein.proportion,
         process.bw.kg = bw * process.number / 1000,
         process.feed.kg = process.bw.kg * feed.rate,
         process.protein = process.feed.kg * protein.proportion)
```

``` {r system_individuals_primo, fig.cap = "Total number of individuals per phase ($95^{th} st.$ 2023).", fig.align = "center", fig.dim = c(8,4)}

system.n.primo <- system.loading.primo %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, total.number, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Day", y = "Number of Shrimp in Batch") + 
  theme_minimal()

system.n.primo
```

``` {r process_individuals_primo, fig.cap = "Total number of individuals per process ($95^{th} st.$ 2023).", fig.align = "center", fig.dim = c(8,4)}

tank.n.primo <- system.loading.primo %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, process.number, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "Number of Shrimp in Process") + 
  theme_minimal()

tank.n.primo
```

101^st^ st. 2024 system designations:

``` {r facility_101}

# system loading for 101
quarantine.in.101.a <- 65000
quarantine.in.101.b <- 100000
nursery.in.101.a <- 23000 * 2
nursery.in.101.b <- 23000 * 3
growout.in.101.a <- 5200 * 4
growout.in.101.b <- 5200 * 6
depurate.in.101 <- 1600
nursery.harvest.101 <- 4000

harvest.101.1 <- 1200
harvest.101.2 <- 600
harvest.101.3 <- 600

quarantine.101.division <- 1
nursery.101.division <- 2
growout.101.division.a <- 4
growout.101.division.b <- 2
growout.101.tank.multiplier <- 6
depurate.101.division <- 1
depurate.tanks.101 <- 4
```

* Quarantine - initial population of `r format(quarantine.in.101.a, scientific = FALSE)`- `r format(quarantine.in.101.b, scientific = FALSE)` individuals of body-weight `r bw_0` : `r quarantine.max`
* Nursery - divide `r format(nursery.in.101.a, scientific = FALSE)` - `r format(nursery.in.101.b, scientific = FALSE)`, `r quarantine.max`g, shrimp between `r nursery.101.division` independently operating tank(s), raise to `r juvenile.max`g.
* Growout - rear `r format(growout.in.101.a, scientific = FALSE)` - `r format(growout.in.101.b, scientific = FALSE)`, `r juvenile.max`g, shrimp within `r growout.101.division.a` - `r growout.101.tank.multiplier` tank(s), raise to `r growout.max`g.
* Depuration - purge up to `r format(depurate.in.primo, scientific = FALSE)`, `r growout.max`g shrimp - split between `r depurate.tanks.primo` tank(s), operated by `r depurate.primo.division` treatment system(s).

``` {r system_loading_101}

# build system loading onto production plan 101
system.loading.101 <- prod.plan.101 %>%
  mutate(total.number = case_when(system == "quarantine" ~ quarantine.in.101.a * exp(1)^(log(quarantine.survival) / quarantine.period.101 * batch_day),
                                  system == "nursery" ~ nursery.in.101.a * exp(1)^(log(nursery.survival) / nursery.period.101 * (batch_day - (quarantine.period.101 + 1))),
                                  system == "growout" ~ growout.in.101.a * exp(1)^(log(growout.survival) / growout.period.101 * (batch_day - (quarantine.period.101 + 1) - nursery.period.101)),
                                  system == "depurate" ~ depurate.in.101),
         total.number = case_when(system == "quarantine" & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ quarantine.in.101.b * exp(1)^(log(quarantine.survival) / quarantine.period.101 * batch_day), TRUE ~ total.number),
         total.number = case_when(system == "nursery" & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ nursery.in.101.b * exp(1)^(log(nursery.survival) / nursery.period.101 * (batch_day - (quarantine.period.101 + 1))), TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ growout.in.101.b * exp(1)^(log(growout.survival) / growout.period.101 * (batch_day - (quarantine.period.101 + 1) - nursery.period.101)), TRUE ~ total.number),
         total.number = case_when(system == "nursery" & batch_day >= shrimp.5.g ~ total.number - nursery.harvest.101 * nursery.101.division, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g ~ total.number - harvest.101.1 * growout.101.division.a, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 15 ~ total.number - harvest.101.2 * growout.101.division.a, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 30 ~ total.number - harvest.101.3 * growout.101.division.a, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ total.number - harvest.101.1 * growout.101.division.b, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 15 & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ total.number - harvest.101.2 * growout.101.division.b, TRUE ~ total.number),
         total.number = case_when(system == "growout" & batch_day >= shrimp.32.g + 30 & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ total.number - harvest.101.3 * growout.101.division.b, TRUE ~ total.number),
         process.number = case_when(system == "quarantine" ~ total.number / quarantine.101.division,
                                    system == "nursery" ~ total.number / nursery.101.division,
                                    system == "growout" ~ total.number / growout.101.division.a,
                                    system == "depurate" ~ total.number / depurate.101.division),
         process.number = case_when(system == "growout" & batch %in% c("lag.batch.1", "lag.batch.3", "lag.batch.5", "lag.batch.7", "lag.batch.9", "lag.batch.11") ~ total.number / growout.101.tank.multiplier, TRUE ~ process.number),
         bw = case_when(system == "depurate" ~ 32, TRUE ~ (bw_0^c_1 + c_2 * batch_day)^c_4),
         feed.rate = case_when(system == "quarantine" ~ exp(quarantine.feed.twinlog$coef[1]) * bw ^ quarantine.feed.twinlog$coef[2],
                               system == "nursery" ~ exp(juvenile.nursery.feed.log$coef[1] + bw * juvenile.nursery.feed.log$coef[2]),
                               system == "growout" ~ growout.feed,
                               system == "depurate" ~ depurate.feed),
         protein.proportion = case_when(system == "quarantine" ~ quarantine.protein,
                                        system == "nursery" ~ nursery.protein,
                                        system == "growout" ~ growout.protein,
                                        system == "depurate" ~ depurate.protein),
         total.bw.kg = bw * total.number / 1000,
         total.feed.kg = total.bw.kg * feed.rate,
         total.protein = total.feed.kg * protein.proportion,
         process.bw.kg = bw * process.number / 1000,
         process.feed.kg = process.bw.kg * feed.rate,
         process.protein = process.feed.kg * protein.proportion)
```

```{r system_individuals_101, fig.cap = "Total number of individuals per phase ($101^{st} st.$ 2024).", fig.align = "center", fig.dim = c(8,4)}

batch.names <- c("lag.batch.0" = "Batch 1", "lag.batch.1" = "Batch 2")

system.n.101 <- system.loading.101 %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.1")) %>%
  ggplot(aes(batch_day, total.number, color = system)) +
  geom_line() +
  xlim(0, 210) +
  facet_wrap(~batch, ncol = 1, labeller = as_labeller(batch.names)) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "Number of Shrimp in Batch") + 
  theme_minimal()

system.n.101
```

``` {r process_individuals_101, fig.cap = "Total number of individuals per process ($101^{st} st.$ 2024).", fig.align = "center", fig.dim = c(8,4)}

tank.n.101 <- system.loading.101 %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.1")) %>%
  ggplot(aes(batch_day, process.number, color = system)) +
  geom_line()+
  facet_wrap(~batch, ncol = 1, labeller = as_labeller(batch.names)) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "Number of Shrimp in Process") + 
  theme_minimal()

tank.n.101
```

The following feeding models were developed to estimate system loading across the production cycle through the developmental phases:

``` {r feed_plot, fig.cap = "Feeding model - overlaid on feed tables.", fig.align = "center", fig.dim = c(8,4)}

feed.plot <- feed %>%
  ggplot(aes(wt, feed_pc, color = phase)) +
  geom_line()+
  stat_function(fun = function(x) exp(quarantine.feed.twinlog$coef[1]) * x ^ quarantine.feed.twinlog$coef[2],
                color = 'orange', xlim = c(0.007, 1.2), alpha = 0.4) +
  stat_function(fun = function(x) nursery.feed,
                color = "orange", xlim = c(1.2, 3.0), alpha = 0.4) +
  stat_function(fun = function(x) exp(juvenile.feed.log$coef[1] + x * juvenile.feed.log$coef[2]),
                color = 'orange', xlim = c(3.0, 10), alpha = 0.4) +
  stat_function(fun = function(x) growout.feed,
                color = "orange", xlim = c(10, 32), alpha = 0.4) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "juvenile", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Juvenile", "Growout", "Depurate")) +
  labs(x = "Shrimp bodyweight (g)", y = "Feed as percentage of bodyweight (%)") + 
  theme_minimal()

feed.plot
```

95^th^ st. (2022) System Loading:

``` {r feed_loading_95}

# get max loading for each system (overlapping batches where appropriate)
avg.loading.95 <- system.loading %>%
  group_by(system, facility_day) %>%
  summarise(n_sum = sum(total.number),
            feed.sum = sum(total.feed.kg),
            protein.sum = sum(total.protein)) %>%
  summarise(n_max = max(n_sum),
            feed.avg = mean(feed.sum),
            feed.max = max(feed.sum),
            protein.avg = mean(protein.sum),
            protein.max = max(protein.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))
```

Feed and protein maximum and average loading rates per day per system (phase).

``` {r feed_loading_table_95}
knitr::kable(avg.loading.95, digits = 2, caption = "$95^{th} st.$ 2022 facility loading rates (overlapping batches where appropriate).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling(latex_options = "hold_position")
```

Feed and protein maximum and average loading rates per day per process unit (tank or series of connected tanks per phase).

``` {r feed_loading_unit95}

# get max loading for individual system processes - filter one batch
process.loading_95 <- system.loading %>%
  filter(batch == "lag.batch.0") %>%
  group_by(system) %>%
  summarise(n_max = max(process.number),
            feed.avg = mean(process.feed.kg),
            feed.max = max(process.feed.kg),
            protein.avg = mean(process.protein),
           protein.max = max(process.protein)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))
```

``` {r feed_loading_table_unit95}
knitr::kable(process.loading_95, digits = 2, caption = "$95^{th} st.$ 2022 process unit loading rates (single batch modelled).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling(latex_options = "hold_position")
```

95^th^ st. (2023) System Loading:

``` {r feed_loading_primo}

# get max loading for each system in primo (overlapping batches where appropriate)
avg.loading.primo <- system.loading.primo %>%
  group_by(system, facility_day) %>%
  summarise(n_sum = sum(total.number),
            feed.sum = sum(total.feed.kg),
            protein.sum = sum(total.protein)) %>%
  summarise(n_max = max(n_sum),
            feed.avg = mean(feed.sum),
            feed.max = max(feed.sum),
            protein.avg = mean(protein.sum),
            protein.max = max(protein.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "growout", "depurate")))
```

Feed and protein maximum and average loading rates per day per system (phase).

``` {r feed_loading_table_primo}
knitr::kable(avg.loading.primo, digits = 2, caption = "$95^{th} st.$ 2023 facility loading rates (overlapping batches where appropriate).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling()
```

Feed and protein maximum and average loading rates per day per process unit (tank or series of connected tanks per phase).

``` {r feel_loading_unit_primo}

# get max loading for individual system processes - filter one batch
process.loading_primo <- system.loading.primo %>%
  filter(batch == "lag.batch.0") %>%
  group_by(system) %>%
  summarise(n_max = max(process.number),
            feed.avg = mean(process.feed.kg),
            feed.max = max(process.feed.kg),
            protein.avg = mean(process.protein),
            protein.max = max(process.protein)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "growout", "depurate")))
```

``` {r feed_loading_table_unit_primo}
knitr::kable(process.loading_primo, digits = 2, caption = "$95^{th} st.$ 2023 process unit loading rates (single batch modelled).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling()
```

101^st^ st. (2024) System Loading:

``` {r feed_loading_101}

# get max loading for each system in primo (overlapping batches where appropriate)
avg.loading.101 <- system.loading.101 %>%
  group_by(system, facility_day) %>%
  summarise(n_sum = sum(total.number),
            feed.sum = sum(total.feed.kg),
            protein.sum = sum(total.protein)) %>%
  summarise(n_max = max(n_sum),
            feed.avg = mean(feed.sum),
            feed.max = max(feed.sum),
            protein.avg = mean(protein.sum),
            protein.max = max(protein.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "growout", "depurate")))
```

Feed and protein maximum and average loading rates per day per system (phase).

``` {r feed_loading_table_101}
knitr::kable(avg.loading.101, digits = 2, caption = "$101^{st} st.$ 2024 facility loading rates (overlapping batches where appropriate).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling()
```

Feed and protein maximum and average loading rates per day per process unit (tank or series of connected tanks per phase).

``` {r feed_loading_101a_unit}

# get max loading for individual system processes - filter one batch
process.loading_101.a <- system.loading.101 %>%
  filter(batch == "lag.batch.0") %>%
  group_by(system) %>%
  summarise(n_max = max(process.number),
            feed.avg = mean(process.feed.kg),
            feed.max = max(process.feed.kg),
            protein.avg = mean(process.protein),
            protein.max = max(process.protein)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "growout", "depurate")))
```

``` {r feed_loading_table_unit_101a}
knitr::kable(process.loading_101.a, digits = 2, caption = "$101^{st} st. 2024 process unit loading rates (single batch a modelled).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling()
```

``` {r feed_loading_101b_unit}

# get max loading for individual system processes - filter one batch
process.loading_101.b <- system.loading.101 %>%
  filter(batch == "lag.batch.1") %>%
  group_by(system) %>%
  summarise(n_max = max(process.number),
            feed.avg = mean(process.feed.kg),
            feed.max = max(process.feed.kg),
            protein.avg = mean(process.protein),
            protein.max = max(process.protein)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "growout", "depurate")))
```

``` {r feed_loading_table_unit_101b}
knitr::kable(process.loading_101.b, digits = 2, caption = "$101^{st} st.$ 2024 process unit loading rates (single batch b modelled).", col.names = c("System", "Max n", "Feed avg", "Feed max", "Protein avg", "Protein max")) %>%
  kable_styling()
```

***

## Water Quality Defining Parameters

Based on feed inputs, the following parameters (inputs or requirements) can be modelled:

* TAN--N Total ammonia nitrogen produced (ionised ammonia + un-ionised ammonia NH~4~^+^--N + NH~3~--N)
* TSS Total suspended solids produced
* CO~2~ Carbon dioxide produced
* O~2~D Oxygen demand
* Alk Alkalinity demand
* Carb Carbohydrate demand

``` {r loading_parameters_95}

# 95 st 2022 loading parameters
# for marine shrimp in zero-exchange system, Ptan = F * PC * 0.144
# for starvation, TAN =  0.067 mg N-NH3 / h / g
# starvation oxygen consumption ~ 1 mg Oxy/g/h
# carb calculations: TAN * 15.17 is carb requirement, less feed carb content feed * 0.1089 / 0.4
system.parameters.95 <- system.loading %>%
  mutate(total.tan = case_when(system == "depurate" ~ total.bw.kg * 0.067 * 24 / 1000,
                               TRUE ~ total.feed.kg * protein.proportion * 0.144), # total tan in kg
         process.tan = case_when(system == "depurate" ~ process.bw.kg * 0.067 * 24 / 1000,
                                 TRUE ~ process.feed.kg * protein.proportion * 0.144), 
         total.tss = case_when(system == "quarantine" ~ total.feed.kg * 0.25,
                               system == "depurate" ~ total.tan * 0.2,
                               TRUE ~ (total.feed.kg * 0.25) + (total.tan * 8.07)),
         process.tss = case_when(system == "quarantine" ~ process.feed.kg * 0.25,
                                 system == "depurate" ~ process.tan * 0.2,
                                 TRUE ~ (process.feed.kg * 0.25) + (process.tan * 8.07)),
         total.od = case_when(system == "quarantine" ~ total.feed.kg * 0.25 + total.tan * 4.57,
                              system == "depurate" ~ total.bw.kg * 1 / 1000 * 24,
                              TRUE ~ (total.feed.kg * 0.25) + (total.tan * 4.71)),
         process.od = case_when(system == "quarantine" ~ process.feed.kg * 0.25 + process.tan * 4.57,
                                system == "depurate" ~ process.bw.kg * 1 / 1000 * 24,
                                TRUE ~ (process.feed.kg * 0.25) + (process.tan * 4.71)),
         total.alk = case_when(system == "quarantine" | system == "depurate" ~ total.tan * 7.05,
                               TRUE ~ total.tan * 3.57), # 3.57 g of alkalinity consumed in heterotrophic systems
         process.alk = case_when(system == "quarantine" | system == "depurate" ~ process.tan * 7.05,
                                 TRUE ~ process.tan * 3.57),
         total.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                TRUE ~ total.feed.kg * protein.proportion * 0.144 * 15.17 - (total.feed.kg * 0.1089 / 0.4)),
         process.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                  TRUE ~ process.feed.kg * protein.proportion * 0.144 * 15.17 - (process.feed.kg * 0.1089 / 0.4)),
         total.co2 =  total.od * 1.375,
         process.co2 = process.od * 1.375)
```

``` {r loading_parameters_primo}

# 95 st 2023 loading parameters
# for marine shrimp in zero-exchange system, Ptan = F * PC * 0.144
system.parameters.primo <- system.loading.primo %>%
  mutate(total.tan = case_when(system == "depurate" ~ total.bw.kg * 0.067 * 24 / 1000,
                               TRUE ~ total.feed.kg * protein.proportion * 0.144), # total tan in kg
         process.tan = case_when(system == "depurate" ~ process.bw.kg * 0.067 * 24 / 1000,
                                 TRUE ~ process.feed.kg * protein.proportion * 0.144), 
         total.tss = case_when(system == "quarantine" ~ total.feed.kg * 0.25,
                               system == "depurate" ~ total.tan * 0.2,
                               TRUE ~ (total.feed.kg * 0.25) + (total.tan * 8.07)),
         process.tss = case_when(system == "quarantine" ~ process.feed.kg * 0.25,
                                 system == "depurate" ~ process.tan * 0.2,
                                 TRUE ~ (process.feed.kg * 0.25) + (process.tan * 8.07)),
         total.od = case_when(system == "quarantine" ~ total.feed.kg * 0.25 + total.tan * 4.57,
                              system == "depurate" ~ total.bw.kg * 1 / 1000 * 24,
                              TRUE ~ (total.feed.kg * 0.25) + (total.tan * 4.71)),
         process.od = case_when(system == "quarantine" ~ process.feed.kg * 0.25 + process.tan * 4.57,
                                system == "depurate" ~ process.bw.kg * 1 / 1000 * 24,
                                TRUE ~ (process.feed.kg * 0.25) + (process.tan * 4.71)),
         total.alk = case_when(system == "quarantine" | system == "depurate" ~ total.tan * 7.05,
                               TRUE ~ total.tan * 3.57), # 3.57 g of alkalinity consumed in heterotrophic systems
         process.alk = case_when(system == "quarantine" | system == "depurate" ~ process.tan * 7.05,
                                 TRUE ~ process.tan * 3.57),
         total.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                TRUE ~ total.feed.kg * protein.proportion * 0.144 * 15.17 - (total.feed.kg * 0.1089 / 0.4)),
         process.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                  TRUE ~ process.feed.kg * protein.proportion * 0.144 * 15.17 - (process.feed.kg * 0.1089 / 0.4)),
         total.co2 =  total.od * 1.375,
         process.co2 = process.od * 1.375)
```

``` {r loading_parameters_101}

# 101 st 2024 loading parameters
# for marine shrimp in zero-exchange system, Ptan = F * PC * 0.144
system.parameters.101 <- system.loading.101 %>%
  mutate(total.tan = case_when(system == "depurate" ~ total.bw.kg * 0.067 * 24 / 1000,
                               TRUE ~ total.feed.kg * protein.proportion * 0.144), # total tan in kg
         process.tan = case_when(system == "depurate" ~ process.bw.kg * 0.067 * 24 / 1000,
                                 TRUE ~ process.feed.kg * protein.proportion * 0.144), 
         total.tss = case_when(system == "quarantine" ~ total.feed.kg * 0.25,
                               system == "depurate" ~ total.tan * 0.2,
                               TRUE ~ (total.feed.kg * 0.25) + (total.tan * 8.07)),
         process.tss = case_when(system == "quarantine" ~ process.feed.kg * 0.25,
                                 system == "depurate" ~ process.tan * 0.2,
                                 TRUE ~ (process.feed.kg * 0.25) + (process.tan * 8.07)),
         total.od = case_when(system == "quarantine" ~ total.feed.kg * 0.25 + total.tan * 4.57,
                              system == "depurate" ~ total.bw.kg * 1 / 1000 * 24,
                              TRUE ~ (total.feed.kg * 0.25) + (total.tan * 4.71)),
         process.od = case_when(system == "quarantine" ~ process.feed.kg * 0.25 + process.tan * 4.57,
                                system == "depurate" ~ process.bw.kg * 1 / 1000 * 24,
                                TRUE ~ (process.feed.kg * 0.25) + (process.tan * 4.71)),
         total.alk = case_when(system == "quarantine" | system == "depurate" ~ total.tan * 7.05,
                               TRUE ~ total.tan * 3.57), # 3.57 g of alkalinity consumed in heterotrophic systems
         process.alk = case_when(system == "quarantine" | system == "depurate" ~ process.tan * 7.05,
                                 TRUE ~ process.tan * 3.57),
         total.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                TRUE ~ total.feed.kg * protein.proportion * 0.144 * 15.17 - (total.feed.kg * 0.1089 / 0.4)),
         process.carb = case_when(system == "quarantine" | system == "depurate" ~ 0,
                                  TRUE ~ process.feed.kg * protein.proportion * 0.144 * 15.17 - (process.feed.kg * 0.1089 / 0.4)),
         total.co2 =  total.od * 1.375,
         process.co2 = process.od * 1.375)
```

``` {r mass_balance_parameters}

# define water quality parameters
desired.tss <- 250 # max 50 mg/l in tanks
desired.o2 <- 5.0 # min 5 mg/l in tanks
desired.tan <- 1 # max 1 mg/l TAN in tanks
desired.nitrate <- 50 # max 50 mg/l nitrate in tanks
desired.co2 <- 15 # max 15 mg/l in tanks
desired.t <- 30 # system operating temp in C
site.altitude <- 10 # site altitude in metres
cone.bar <- 0.7
feeding.period <- 24
metabolic.period <- case_when(feeding.period < 20 ~ feeding.period + 4, TRUE ~ 24)

# constants
k <- 1.42903
beta.oxygen <- exp(-58.3877 + 85.8079 *  (100/(desired.t + 273.15)) + 23.8439 * log((desired.t+273.15) / 100))
barometric.pressure <- 10^(2.88014 - site.altitude/19748.2)
water.v.pressure <- 4.7603 * exp(0.0645 * desired.t)
oxygen.percent <- 20.95
oxygen.saturation <- 1000 * k * beta.oxygen * oxygen.percent / 100 * ((barometric.pressure - water.v.pressure) / 760) # if cone used at pressure swap out barometric.pressure for cone.pressure
cone.pressure <- cone.bar * 750.06 + barometric.pressure
oxygen.saturation.saline <- oxygen.saturation * 0.8
```

``` {r mass_balance_equations}

# component specifics
# system efficiency 
tan.c1 <- desired.tan
tan.cbest <- 0
tan.te <- 0.9
tan.c2 <- tan.c1 + tan.te * (tan.cbest - tan.c1)

co2.c1 <- desired.co2
co2.cbest <- 0.5
co2.te <- 0.7
co2.c2 <- co2.c1 + co2.te * (co2.cbest - co2.c1)

tss.c1 <- desired.tss
tss.cbest <- 0
tss.te <- 0.21
tss.c2 <- tss.c1 + tss.te * (tss.cbest - tss.c1)

oxy.c1 <- desired.o2 # min 5 mg/l in tanks
oxy.cbest <- oxygen.saturation.saline
oxy.te <- 0.99
oxy.c2 <- oxy.c1 + oxy.te * (oxy.cbest - oxy.c1)
```

***

## Nitrogen Management

TAN--N loading

95^th^ st. 2022 TAN--N summary

``` {r tan_summary_95}

# get max tan loading for each system 95th st 2022 (overlapping batches where appropriate)
tan.system.95 <- system.parameters.95 %>%
  group_by(system, facility_day) %>%
  summarise(tan.sum = sum(total.tan)) %>%
  summarise(tan.s.max = max(tan.sum),
            tan.s.avg = mean(tan.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tan loading for individual system processes 95th st 2022
tan.process.95 <- system.parameters.95 %>%
  group_by(system) %>%
  summarise(tan.p.max = max(process.tan),
            tan.p.avg = mean(process.tan)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tan summary tibbles 95th st 2022
tan.summary.95 <- left_join(tan.system.95, tan.process.95, by = "system")
```

``` {r tan_loading_table_95}
knitr::kable(tan.summary.95, digits = 2, caption = "$95^{th} st.$ 2022 TAN--N system and process loading summary.", col.names = c("System", "System max TAN", "System avg TAN", "Process max TAN", "Process avg TAN")) %>%
  kable_styling()
```

``` {r tan_profile_95, fig.cap = "$95^{th} st.$ 2022 process/ tank TAN--N profile.", fig.align = "center", fig.dim = c(8,4)}

# plot tan loading across batch run 95th st 2022
tank.tan.95 <- system.parameters.95 %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, process.tan, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "juvenile", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Juvenile", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "TAN--N (kg)") + 
  theme_minimal()

tank.tan.95
```

95^th^ st. 2023 TAN--N summary

``` {r tan_summary_primo}

# get max tan loading for each system 95th st 2023 (overlapping batches where appropriate)
tan.system.primo <- system.parameters.primo %>%
  group_by(system, facility_day) %>%
  summarise(tan.sum = sum(total.tan)) %>%
  summarise(tan.s.max = max(tan.sum),
            tan.s.avg = mean(tan.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tan loading for individual system processes 95th st 2023
tan.process.primo <- system.parameters.primo %>%
  group_by(system) %>%
  summarise(tan.p.max = max(process.tan),
            tan.p.avg = mean(process.tan)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tan summary tibbles 95th st 2023
tan.summary.primo <- left_join(tan.system.primo, tan.process.primo, by = "system")
```

``` {r tan_loading_table_primo}
knitr::kable(tan.summary.primo, digits = 2, caption = "$95^{th} st.$ 2023 TAN--N system and process loading summary.", col.names = c("System", "System max TAN", "System avg TAN", "Process max TAN", "Process avg TAN")) %>%
  kable_styling()
```

``` {r tan_profile_primo, fig.cap = "$95^{th} st.$ 2023 process/ tank TAN--N profile.", fig.align = "center", fig.dim = c(8,4)}

# plot tan loading across batch run 95th st 2023
tank.tan.primo <- system.parameters.primo %>%
  filter(batch == "lag.batch.0") %>%
  ggplot(aes(batch_day, process.tan, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Batch Day", y = "TAN--N (kg)") + 
  theme_minimal()

tank.tan.primo
```

101^st^ st. 2024 TAN--N summary

``` {r tan_summary_101}

# get max tan loading for each system 101th st 2024 (overlapping batches where appropriate)
tan.system.101 <- system.parameters.101 %>%
  group_by(system, facility_day) %>%
  summarise(tan.sum = sum(total.tan)) %>%
  summarise(tan.s.max = max(tan.sum),
            tan.s.avg = mean(tan.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tan loading for individual system processes 101st st 2024 4 raceway batch
tan.process.101a <- system.parameters.101 %>%
  filter(batch == "lag.batch.0") %>%
  group_by(system) %>%
  summarise(tan.p.max.a = max(process.tan),
            tan.p.avg.a = mean(process.tan)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tan loading for individual system processes 101st st 2024 6 raceway batch
tan.process.101b <- system.parameters.101 %>%
  filter(batch == "lag.batch.1") %>%
  group_by(system) %>%
  summarise(tan.p.max.b = max(process.tan),
            tan.p.avg.b = mean(process.tan)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tan summary tibbles 101st st 2024
tan.summary.101 <- left_join(tan.system.101, tan.process.101a, by = "system") %>%
  left_join(., tan.process.101b, by = "system")
```


``` {r tan_loading_table_101}
knitr::kable(tan.summary.101, digits = 2, caption = "$101^{st} st.$ 2024 TAN--N system and process loading summary.", col.names = c("System", "System max TAN", "System avg TAN", "Process max TAN A", "Process avg TAN A", "Process max TAN B", "Process avg TAN B")) %>%
  kable_styling()
```

``` {r tan_profile_101, fig.cap = "$101^{th} st.$ 2024 process/ tank TAN--N profile.", fig.align = "center", fig.dim = c(8,4)}

# plot tan loading across batch run 101st st 2024
tank.tan.101 <- system.parameters.101 %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.1")) %>%
  ggplot(aes(facility_day, process.tan, color = system)) +
  geom_line()+
  facet_wrap(~batch, ncol = 1, labeller = as_labeller(batch.names)) +
  scale_color_manual("", breaks = c("quarantine", "nursery", "growout", "depurate"),
                     values = c(system_cols),
                     labels = c("Quarantine", "Nursery", "Growout", "Depurate")) +
  labs(x = "Facility Day", y = "TAN--N (kg)") + 
  theme_minimal()

tank.tan.101
```

Ammonia removal from intensive aquaculture production can be managed by three distinct pathways:

* Photoautotrophic (algal)
* Autotrophic (bacterial)
* Heterotrophic (bacterial)

Of relevance in the production process at SyAqua Americas are autotrophic (quarantine and depuration/ purging) and heterotrophic (nursery, juvenile and grow-out) pathways.

Chemoautotrophic pathway (simplified) NH~4~^+^ + O~2~ + alkalinity &rarr; NO~2~^-^ &rarr; NO~3~^-^ + CO~2~ + small amount of bacterial biomass

Heterotrophic pathway (simplified) NH~4~^+^ + O~2~ + alkalinity + organic C &rarr; large amount of bacterial biomass + CO~2~

The carbon/ nitrogen ratio influences the relative proportion of autotrophic/ heterotrophic bacterial community and therefore may be used as a management tool for determination of nitrogen removal pathway.

Stoichiometric equations predict that for every g of ammonia-nitrogen converted to microbial biomass (by heterotrophic bacteria), 15.17 g of carbohydrates or 6.07 g of organic carbon is consumed. Organic carbon can be made available from livestock feed constituents and supplementary carbohydrate additions e.g. molasses or other source.

NH~4~^+^ -- N within the quarantine systems would typically be removed primarily by the chemoautotrophic pathway, utilising a fixed film moving-bed bioreactor. The volume of the biomedia would be dictated by the surface area and the maximum potential daily NH~4~^+^ -- N loading. 

Suggested minimum quarantine biomedia surface areas are as follows (based on a 24 hr metabolic period):

95^th^ st. 2022; `r format(tan.summary.95[1,2] / (0.4 / 1000), digits = 3)`m^2^  
95^th^ st. 2023; `r format(tan.summary.primo[1,2] / (0.4 / 1000), digits = 3)`m^2^  
101^st^ st. 2024; `r format(tan.summary.101[1,2] / (0.4 / 1000), digits = 3)`m^2^

NH~4~^+^ -- N within the depuration/ purging systems would typically be managed by water exchange and minimal nitrification/ ammonia sequestration from bacteria present in the sand filter/ water column.

The charts below indicate theoretical carbohydrate additions required to supplement organic carbon supplied in feed (nursery/ juvenile/ grow-out stages only). 

Calculations based upon:

TAN produced * bacterial carbohydrate demand - carbohydrate in feed

Feed input * protein proportion * 0.144 * 15.17 - (feed input * 0.1089 / 0.4)

95^th^ st. 2022

``` {r carb_profile_95, fig.cap = "$95^{th} st.$ 2022 Theoretical supplimentary carbohydrate requirement (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot carb requirement across batch run 95th st 2022
tank.carb.95 <- system.parameters.95 %>%
  filter(batch == "lag.batch.0" & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(batch_day, process.carb, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("nursery", "juvenile", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Juvenile", "Growout")) +
  labs(x = "Batch Day", y = "Supplimentary carbohydrate required (kg per day)") + 
  theme_minimal()

tank.carb.95
```

95^th^ st. 2023

``` {r carb_profile_primo, fig.cap = "$95^{th} st.$ 2023 Theoretical supplimentary carbohydrate requirement (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot carb requirement across batch run 95th st 2023
tank.carb.primo <- system.parameters.primo %>%
  filter(batch == "lag.batch.0" & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(batch_day, process.carb, color = system)) +
  geom_line()+
  scale_color_manual("", breaks = c("nursery", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Growout")) +
  labs(x = "Batch Day", y = "Supplimentary carbohydrate required (kg per day)") + 
  theme_minimal()

tank.carb.primo
```

101^st^ st. 2024

``` {r carb_profile_101, fig.cap = "$101^{st} st.$ 2024 Theoretical supplimentary carbohydrate requirement (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot tan loading across batch run 101st st 2024
tank.carb.101 <- system.parameters.101 %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.1") & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(facility_day, process.carb, color = system)) +
  geom_line()+
  facet_wrap(~batch, ncol = 1, labeller = as_labeller(batch.names)) +
  scale_color_manual("", breaks = c("nursery", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Growout")) +
  labs(x = "Facility Day", y = "Supplimentary carbohydrate required (kg per day)") + 
  theme_minimal()

tank.carb.101
```

***

## Solids Management

Solids within the production process will be comprised of uneaten feed, faeces and bacterial biomass.

The literature indicates a total suspended solids (TSS) concentration of 200-300 mg/l is typical within biofloc operation, and levels of up to 500 mg/l may be acceptable without reduction of welfare or growth of shrimp. 

Solids concentration will increase in zero exchange systems and active management techniques may be required to maintain optimal levels of TSS.

TSS accumulation can be modelled according to system management based on feed input for chemoautotrophic-managed nitrogen pathways or feed input and bacterial biomass synthesised for heterotrophic-managed nitrogen pathways.

Solids input

95^th^ st. 2022

``` {r solids_summary_95}

# get max tss loading for each system 95th st 2022 (overlapping batches where appropriate)
tss.system.95 <- system.parameters.95 %>%
  group_by(system, facility_day) %>%
  summarise(tss.sum = sum(total.tss)) %>%
  summarise(tss.s.max = max(tss.sum),
            tss.s.avg = mean(tss.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tss loading for individual system processes 95th st 2022
tss.process.95 <- system.parameters.95 %>%
  group_by(system) %>%
  summarise(tss.p.max = max(process.tss),
            tss.p.avg = mean(process.tss)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tss summary tibbles 95th st 2022
tss.summary.95 <- left_join(tss.system.95, tss.process.95, by = "system")
```

``` {r tss_loading_table_95}
knitr::kable(tss.summary.95, digits = 2, caption = "$95^{th} st.$ 2022 TSS system and process loading summary.", col.names = c("System", "System max TSS", "System avg TSS", "Process max TSS", "Process avg TSS")) %>%
  kable_styling()
```

95^th^ st. 2023

``` {r solids_summary_primo}

# get max tss loading for each system 95th st 2023 (overlapping batches where appropriate)
tss.system.primo <- system.parameters.primo %>%
  group_by(system, facility_day) %>%
  summarise(tss.sum = sum(total.tss)) %>%
  summarise(tss.s.max = max(tss.sum),
            tss.s.avg = mean(tss.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tss loading for individual system processes 95th st 2023
tss.process.primo <- system.parameters.primo %>%
  group_by(system) %>%
  summarise(tss.p.max = max(process.tss),
            tss.p.avg = mean(process.tss)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tss summary tibbles 95th st 2023
tss.summary.primo <- left_join(tss.system.primo, tss.process.primo, by = "system")
```

``` {r tss_loading_table_primo}
knitr::kable(tss.summary.primo, digits = 2, caption = "$95^{th} st.$ 2023 TSS system and process loading summary.", col.names = c("System", "System max TSS", "System avg TSS", "Process max TSS", "Process avg TSS")) %>%
  kable_styling()
```

101^st^ st. 2024

``` {r solids_summary_101}

# get max tss loading for each system 101th st 2024 (overlapping batches where appropriate)
tss.system.101 <- system.parameters.101 %>%
  group_by(system, facility_day) %>%
  summarise(tss.sum = sum(total.tss)) %>%
  summarise(tss.s.max = max(tss.sum),
            tss.s.avg = mean(tss.sum)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tss loading for individual system processes 101st st 2024 4 raceway batch
tss.process.101a <- system.parameters.101 %>%
  filter(batch == "lag.batch.0") %>%
  group_by(system) %>%
  summarise(tss.p.max.a = max(process.tss),
            tss.p.avg.a = mean(process.tss)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# get max tss loading for individual system processes 101st st 2024 6 raceway batch
tss.process.101b <- system.parameters.101 %>%
  filter(batch == "lag.batch.1") %>%
  group_by(system) %>%
  summarise(tss.p.max.b = max(process.tss),
            tss.p.avg.b = mean(process.tss)) %>%
  arrange(factor(system, levels = c("quarantine", "nursery", "juvenile", "growout", "depurate")))

# join tss summary tibbles 101st st 2024
tss.summary.101 <- left_join(tss.system.101, tss.process.101a, by = "system") %>%
  left_join(., tss.process.101b, by = "system")
```

``` {r tss_loading_table_101}
knitr::kable(tss.summary.101, digits = 2, caption = "$101^{st} st.$ 2024 TSS system and process loading summary.", col.names = c("System", "System max TSS", "System avg TSS", "Process max TSS A", "Process avg TSS A", "Process max TSS B", "Process avg TSS B")) %>%
  kable_styling()
```

A cumulative TSS sum may give an indication of the timing within the production run that the desired TSS will be achieved. From this point onwards, solids will require either continuous or periodic removal to maintain TSS within acceptable limits.

Calculations based upon full tanks:

``` {r tank_volumes}

# tank volumes
nursery.tank <- 15
raceway.tank <- 90
```

* Nursery `r format(nursery.tank, scientific = FALSE)` m^3^
* Juvenile (95^th^ 2022) `r format(raceway.tank, scientific = FALSE)` m^3^
* Growout `r format(raceway.tank, scientific = FALSE)` m^3^

95^th^ st. 2022

``` {r tss_cumsum_95}

# get cumulative sum grouped by system 95th st 2022
cumulative.tss.95 <- system.parameters.95 %>%
  group_by(system) %>%
  mutate(cs = cumsum(process.tss),
         cumulative.tss = case_when(system == "juvenile"  ~ cs * 1e6 / (1000 * raceway.tank),
                                    system == "growout" ~ cs * 1e6 / (1000 * raceway.tank),
                                    system == "nursery" ~ cs * 1e6 / (1000 * nursery.tank),
                                    TRUE ~ 0),
         total.drum.flow = abs(total.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         process.drum.flow = abs(process.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         total.drum.water.use = total.drum.flow * 50 / 1000,
         process.drum.water.use = process.drum.flow * 50 / 1000)
```

``` {r tss_cumplot_95, fig.cap = "$95^{th} st.$ 2022 Cumulative TSS accumulation - without solids management (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot cumulative tss loading across batch run 95th st 2022
tss.cumplot.95 <- cumulative.tss.95 %>%
  filter(batch == "lag.batch.0" & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(batch_day, cumulative.tss, color = system)) +
  geom_line()+
  geom_hline(yintercept=250, linetype="dashed", color = "darkgrey") + 
  scale_color_manual("", breaks = c("nursery", "juvenile", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Juvenile", "Growout")) +
  labs(x = "Batch Day", y = "Cumulative TSS (mg/l)") + 
  theme_minimal()

tss.cumplot.95
```

95^th^ st. 2023

``` {r tss_cumsum_primo}

# get cumulative sum grouped by system 95th st 2023
cumulative.tss.primo <- system.parameters.primo %>%
  group_by(system) %>%
  mutate(cs = cumsum(process.tss),
         cumulative.tss = case_when(system == "growout" ~ cs * 1e6 / (1000 * raceway.tank),
                                    system == "nursery" ~ cs * 1e6 / (1000 * raceway.tank),
                                    TRUE ~ 0),
         total.drum.flow = abs(total.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         process.drum.flow = abs(process.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         total.drum.water.use = total.drum.flow * 50 / 1000,
         process.drum.water.use = process.drum.flow / 0.25 * 50 / 1000)
```

``` {r tss_cumplot_primo, fig.cap = "$95^{th} st.$ 2023 Cumulative TSS accumulation - without solids management (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot cumulative tss loading across batch run 95th st 2023
tss.cumplot.primo <- cumulative.tss.primo %>%
  filter(batch == "lag.batch.0" & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(batch_day, cumulative.tss, color = system)) +
  geom_line()+
  geom_hline(yintercept=250, linetype="dashed", color = "darkgrey") +
  scale_color_manual("", breaks = c("nursery", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Growout")) +
  labs(x = "Batch Day", y = "Cumulative TSS (mg/l)") + 
  theme_minimal()

tss.cumplot.primo
```

101^st^ st. 2024

``` {r tss_cumsum_101}

# get cumulative sum grouped by system 101st st 2024
cumulative.tss.101 <- system.parameters.101 %>%
  group_by(system, batch) %>%
  mutate(cs = cumsum(process.tss),
         cumulative.tss = case_when(system == "growout" ~ cs * 1e6 / (1000 * raceway.tank),
                                    system == "nursery" ~ cs * 1e6 / (1000 * raceway.tank),
                                    TRUE ~ 0),
         total.drum.flow = abs(total.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         process.drum.flow = abs(process.tss * 1e6 / (tss.c2 - tss.c1) / 24 / 1000),
         total.drum.water.use = total.drum.flow * 50 / 1000,
         process.drum.water.use = process.drum.flow * 50 / 1000)
```

``` {r tss_cumplot_101, fig.cap = "$101^{st} st.$ 2024 Cumulative TSS accumulation - without solids management (per tank).", fig.align = "center", fig.dim = c(8,4)}

# plot cumulative tss loading across batch run 101st st 2024
tss.cumplot.101 <- cumulative.tss.101 %>%
  filter(batch %in% c("lag.batch.0", "lag.batch.1") & !system %in% c("quarantine", "depurate")) %>%
  ggplot(aes(facility_day, cumulative.tss, color = system)) +
  geom_line()+
  geom_hline(yintercept=250, linetype="dashed", color = "darkgrey") +
  facet_wrap(~batch, ncol = 1, labeller = as_labeller(batch.names)) +
  scale_color_manual("", breaks = c("nursery", "growout"),
                     values = c(system_cols),
                     labels = c("Nursery", "Growout")) +
  labs(x = "Facility Day", y = "Cumulative TSS (mg/l)") + 
  theme_minimal()

tss.cumplot.101
```

